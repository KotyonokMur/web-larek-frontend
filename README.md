# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Интерфейс карточки товара

```
export interface ICard {
	id: string;
	title: string;
	description: string;
	image: string;
	category: string;
	price?: number;
}
```

Интерфейс формы заказа

```
export interface IOrderForm {
    email?: string;
    phone?: string;
    address?: string;
    paymentType?: string;
}
```

Интерфейс заказа

```
export interface IOrder extends IOrderForm {
    items: string[];
    total: number;
}
```

Интерфейс результата ответа от сервера после оформления заказа

```
export interface IOrderResult {
    id: string;
    total: number;
}
```

Интерфейс состояния приложения

```
export interface IAppState {
    catalog: ICard[];
    basket: string[];
    preview: string | null;
    order: IOrder | null;
    loading: boolean;
}
```

Формы ошибок в полях оформления заказов

```
export type FormErrors = Partial<Record<keyof IOrderForm, string>>;
```

Интерфейс успешного заказа

```
interface ISuccess {
    total: number;
}
```

Действия успешного заказа

```
interface ISuccessActions {
    onClick: () => void;
}
```

Интерфейс продукта

```
export interface IProduct<T> {
    title: string;
    description: string;
    image: string;
    price?: string;
    category: string;
    inBasket: boolean;
    position: number;
}
```

Действия с карточкой товара

```
interface ICardActions {
    onClick: (event: MouseEvent) => void;
}
```

Данные модального окна

```
interface IModalData {
    content: HTMLElement;
}
```

```
export type CatalogChangeEvent = {
    catalog: CardItem[];
};
```

Интерфейс API ларька

```
export interface ILarekAPI {
    getCardList: () => Promise<ICard[]>;
    getCardItem: (id: string) => Promise<ICard>;
}
```

Интерфейс представления корзины

```
interface IBasketView {
    items: HTMLElement[];
    total: number;
}
```

Интерфейс состояния страницы

```
interface IPage {
    counter: number;
    catalog: HTMLElement[];
    locked: boolean;
}
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.\

Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  

Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

#### Класс Model
Базовая модель, обеспечивающая основную функциональность для работы с данными моделей и интеграции с системой событий.\
Класс Model используется для создания моделей данных в приложении. Он принимает данные в виде частичного объекта типа T и экземпляр IEvents для управления событиями. Основной задачей класса является инкапсуляция данных и предоставление методов для уведомления об изменениях модели.\

Методы:
- `emitChanges` - уведомляет всех подписчиков о произошедших изменениях в модели, генерируя соответствующее событие с указанным названием и необязательными дополнительными данными.

#### Класс Component
Базовый компонент, предоставляющий основную функциональность для работы с DOM-элементами и управления их состоянием.\
Класс Component используется для создания UI-компонентов в приложении. Он принимает контейнер HTMLElement и предоставляет методы для работы с DOM-элементами, такие как управление классами, установка текстового содержимого, управление состоянием блокировки, скрытие и показ элементов, установка изображений и рендеринг компонентов.\

Методы:
- `toggleClass` - переключает класс на элементе, принудительно добавляя или удаляя его в зависимости от значения force.
- `setText` - устанавливает текстовое содержимое элемента.
- `setDisabled` - устанавливает или снимает атрибут disabled на элементе.
- `setHidden` - скрывает элемент, устанавливая стиль display: none.
- `setVisible` - показывает элемент, удаляя стиль display.
- `setImage` - устанавливает источник и альтернативный текст для изображения.
- `render` - возвращает корневой DOM-элемент, обновляя данные компонента с использованием переданного объекта.

### Слой данных

#### Класс CardItem
Класс `CardItem` наследуется от базового класса `Model` и представляет собой модель карточки товара.\
Конструктор принимает данные типа `ICard` и объект `IEvents`.
Наследует и передает данные в конструктор базового класса `Model`.\

Поля:
- `id`: `string` - идентификатор товара.
- `image`: `string` - URL изображения товара.
- `title`: `string` - название товара.
- `price`?: `string` - цена товара.
- `description`: `string` - описание товара.
- `category`: `string` - категория товара.
- `inBasket`: `boolean` - флаг, указывающий, находится ли товар в корзине. По умолчанию `false`.

#### Класс AppState
Класс `AppState` наследуется от базового класса `Model` и представляет собой состояние приложения.\

Поля:
- `catalog`: `CardItem[]` - массив товаров в каталоге.
- `order`: `IOrder` - текущий заказ. Инициализируется пустыми значениями.
- `formErrors`: `FormErrors` - ошибки форм заказа и контактов.
Методы:
- `getItem(id: string): CardItem | undefined` - возвращает объект товара из каталога по его идентификатору.
- `setCatalog(items: ICard[]): void` - обновляет каталог товаров. Создает экземпляры `CardItem` и уведомляет об изменениях.
- `toggleOrderedCard(item: CardItem, isIncluded: boolean): void` - добавляет или удаляет товар из корзины и обновляет общую сумму заказа.
- `getBasketCount(): number` - возвращает количество товаров в корзине.
- `clearBasket(): void` - очищает корзину, удаляя все товары и сбрасывая флаги `inBasket`.
- `addItemToBasket(item: CardItem): void` - добавляет товар в корзину и уведомляет об изменениях.
- `removeItemFromBasket(item: CardItem): void` - удаляет товар из корзины и уведомляет об изменениях.
- `getBasketItems(): CardItem[]` - возвращает все товары, находящиеся в корзине.
- `setPreview(item: CardItem): void` - устанавливает товар для предпросмотра и уведомляет об этом.
- `setOrderField(field: keyof IOrderForm, value: string): void` - устанавливает значение поля заказа и выполняет валидацию заказа.
- `validateOrder(): boolean` - проверяет корректность полей заказа и возвращает результат проверки.
- `setContactField(field: keyof IOrderForm, value: string): void` - устанавливает значение поля контактов и выполняет валидацию контактов.
- `validateContacts(): boolean` - проверяет корректность полей контактов и возвращает результат проверки.
- `clearOrderStatus(): void` - очищает статус заказа, сбрасывая значения полей заказа.

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Page
Класс `Page` наследуется от базового класса Component и представляет собой компонент страницы приложения.\

Конструктор:
- `container: HTMLElement` - корневой элемент страницы, в который будет рендериться компонент.
- `events: IEvents` - объект брокера событий для работы с событиями на странице.\
В конструкторе вызывается конструктор родительского класса `Component`. Инициализируются защищенные свойства:
- `_counter: HTMLElement` - элемент счетчика товаров в корзине в шапке страницы.
- `_catalog: HTMLElement` - элемент, представляющий собой галерею товаров на странице.
- `_wrapper: HTMLElement` - обертка страницы, используется для блокировки интерфейса.
- `_basket: HTMLElement` - элемент корзины в шапке страницы.\
Для элемента `_basket` добавляется слушатель события `click`, который при клике на корзину инициирует событие basket:open через объект events.

Сеттеры:
- `set counter(value: number)` - устанавливает количество товаров в корзине и обновляет текстовое содержимое элемента `_counter`.
- `set catalog(items: HTMLElement[])` - устанавливает содержимое галереи товаров, заменяя текущие элементы на новые.
- `set locked(value: boolean)` - блокирует или разблокирует интерфейс страницы путем добавления или удаления `CSS`-класса `page__wrapper_locked` у элемента `_wrapper`.

#### Класс Card
Класс Card наследуется от базового класса `Component` и представляет собой общую модель карточки товара.\

Конструктор:
- `blockName: string` - название блока для поиска элементов внутри контейнера.
- `container: HTMLElement` - корневой элемент, в который будет рендериться компонент карточки.
- `actions?: ICardActions` - объект с действиями, такими как обработчики событий.
Конструктор инициализирует следующие защищенные свойства:
- `_title: HTMLElement` - элемент заголовка карточки.
- `_priceValue: string | null` - значение цены карточки.
- `_image?: HTMLImageElement` - элемент изображения карточки.
- `_button?: HTMLButtonElement` - кнопка для добавления товара в корзину.
- `_price?: HTMLElement` - элемент, отображающий цену карточки.
- `_category?: HTMLElement` - элемент, отображающий категорию товара.
- `_inBasket?: boolean` - флаг, указывающий, добавлен ли товар в корзину.
- `_description?: HTMLElement` - элемент, отображающий описание товара.\

Также определяется приватный объект `categoryClasses`, который связывает категории с соответствующими `CSS`-классами.\
Если передан объект actions и в нем указан обработчик `onClick`, то он добавляется к кнопке `_button` или к контейнеру в зависимости от наличия кнопки.\

Методы:
- `protected getCategoryClass(category: string): string` - возвращает `CSS`-класс для указанной категории.
- `set title(value: string)` - устанавливает заголовок карточки.
- `set price(value: string)` - устанавливает цену карточки. Если цена отсутствует, отображается текст "Бесценно".

#### Класс CatalogItem
Класс `CatalogItem` наследуется от `Card` и используется для отображения карточки товара в каталоге на главной странице.\

Конструктор:
- `container: HTMLElement` - корневой элемент, в который будет рендериться компонент карточки каталога.
- `actions?: ICardActions` - объект с действиями, такими как обработчики событий.\
Конструктор вызывает конструктор родительского класса `Card` с названием блока `card`.\

Сеттеры:
- `set image(value: string)` - устанавливает изображение карточки.
- `set category(value: string)` - устанавливает категорию товара, добавляет соответствующий `CSS`-класс и текстовое содержимое.

#### Класс ProductItem
Класс `ProductItem` наследуется от `Card` и используется для отображения полной информации о продукте и его покупке.\

Конструктор:
- `container: HTMLElement` - корневой элемент, в который будет рендериться компонент карточки продукта.
- `actions?: ICardActions` - объект с действиями, такими как обработчики событий.
Конструктор вызывает конструктор родительского класса `Card` с названием блока `card` и дополнительно инициализирует элемент `_description`.\

Сеттеры:
- `set description(value: string | string[])` - устанавливает описание товара.
- `set inBasket(value: boolean)` - устанавливает флаг наличия товара в корзине и обновляет состояние кнопки.
- `set price(value: string | null)` - устанавливает цену товара и обновляет состояние кнопки.
- `set image(value: string)` - устанавливает изображение товара.
- `set category(value: string)` - устанавливает категорию товара, добавляет соответствующий `CSS`-класс и текстовое содержимое.

Методы:
- `protected updateButtonState()` - обновляет состояние кнопки в зависимости от наличия товара в корзине и наличия цены.

#### Класс BasketItem
Класс `BasketItem` наследуется от `Card` и используется для отображения товаров в корзине.\

Конструктор:
- `container: HTMLElement` - корневой элемент, в который будет рендериться компонент карточки товара в корзине.
- `actions?: ICardActions` - объект с действиями, такими как обработчики событий.
Конструктор вызывает конструктор родительского класса Card с названием блока `card` и дополнительно инициализирует элемент `_position`.\

Сеттеры:
- `set position(value: number)` - устанавливает позицию товара в списке корзины и обновляет текстовое содержимое элемента `_position`.

#### Класс Basket
Класс `Basket` наследуется от базового класса `Component` и представляет собой корзину покупок в приложении.\

Конструктор:
- `container: HTMLElement` - корневой элемент, в который будет рендериться компонент корзины.
- `events: EventEmitter` - объект для управления событиями.
Конструктор инициализирует следующие защищенные свойства:
- `_list: HTMLElement` - элемент, содержащий список товаров в корзине.
- `_total: HTMLElement` - элемент, отображающий общую стоимость товаров в корзине.
- `_button: HTMLElement` - кнопка для оформления заказа.
Если корзина пуста, кнопка _button подписывается на событие `click`, которое вызывает событие `order:open` через `EventEmitter`.\

Сеттеры:
- `set items(items: HTMLElement[])` - метод для установки списка элементов в корзину. Если список не пустой, элементы заменяются на переданные, и кнопка `_button` активируется. Если список пуст, в корзину добавляется сообщение "Корзина пуста", и кнопка `_button` деактивируется.
- `set total(total: number)` - метод для установки и отображения общей стоимости товаров в корзине. Использует метод `setText` для обновления текстового содержимого элемента `_total`.
Методы и функции:
- `ensureElement<HTMLElement>(selector: string, container: HTMLElement): HTMLElement` - утилита для поиска и проверки существования элемента в контейнере по селектору.
- `createElement<T extends HTMLElement>(tagName: string, options: { textContent?: string; className?: string }): T` - утилита для создания `HTML`-элемента с заданными параметрами.
- `setText(element: HTMLElement, value: unknown)` - метод для установки текстового содержимого элемента.
- `setDisabled(element: HTMLElement, state: boolean)` - метод для изменения состояния блокировки элемента (включение/отключение).

#### Класс Modal
Класс `Modal` представляет собой компонент модального окна, наследуемый от базового класса Component. Он обеспечивает функционал для открытия, закрытия модального окна, управления содержимым и обработки событий.

Конструктор:
- `container: HTMLElement` - корневой элемент модального окна, к которому привязывается компонент.
- `events: IEvents` - объект брокера событий для работы с событиями модального окна.

В конструкторе вызывается конструктор родительского класса Component. Инициализируются защищенные свойства:
- `_closeButton: HTMLButtonElement` - кнопка закрытия модального окна.
- `_content: HTMLElement` - контейнер для содержимого модального окна.

Добавляются слушатели событий:
- `'click'` на `_closeButton` и корневом элементе container для закрытия модального окна при клике за его пределами.
- `'click'` на `_content` для предотвращения закрытия модального окна при клике внутри контента.
- `'keydown'` на `document` для закрытия модального окна при нажатии клавиши `Escape`.

Методы и свойства:
- `handleKeydown(event: KeyboardEvent)` - метод для обработки события нажатия клавиши клавиатуры. При нажатии `Escape` закрывает модальное окно.
- `set content(value: HTMLElement)` - сеттер для установки содержимого модального окна. Заменяет текущее содержимое на переданный элемент.
- `open()` - метод для открытия модального окна. Добавляет класс `'modal_active'` к контейнеру модального окна и отправляет событие `'modal:open'`.
- `close()` - метод для закрытия модального окна. Удаляет класс `'modal_active'` у контейнера модального окна, очищает содержимое и отправляет событие `'modal:close'`.
- `render(data: IModalData): HTMLElement` - метод для рендеринга модального окна на основе переданных данных. Вызывает метод `open()` после рендеринга для открытия модального окна. Возвращает корневой элемент модального окна.

#### Класс Form
Класс `Form` представляет собой компонент формы, который наследуется от базового класса Component и предоставляет функционал для работы с формой, обработки ввода данных и отправки событий.

Конструктор:
- `container: HTMLFormElement` - корневой элемент формы, к которому будет привязан компонент.
- `events: IEvents` - объект брокера событий для работы с событиями на форме.

В конструкторе вызывается конструктор родительского класса `Component`. Инициализируются защищенные свойства:
- `_submit: HTMLButtonElement` - кнопка отправки формы.
- `_errors: HTMLElement` - элемент для отображения ошибок формы.

Добавляются слушатели событий:
- `'input'` - для отслеживания ввода данных в поля формы. При вводе вызывается метод `onInputChange`, который отправляет событие с измененными данными.
- `'submit'` - для предотвращения стандартного поведения формы при отправке и отправки события `'formName:submit'` через объект events.
- `'click'` на кнопках выбора типа оплаты (`'card'` и `'cash'`). При клике на кнопку устанавливается активное состояние и отправляется событие с выбранным типом оплаты.

Методы и свойства:
- `onInputChange(field: keyof T, value: string)` - метод для отправки события с измененными данными поля формы.
- `set valid(value: boolean)` - сеттер для установки состояния активности кнопки отправки формы `(_submit.disabled)`.
- `set errors(value: string)` - сеттер для установки текста ошибок в элемент `_errors`.
- `render(state: Partial<T> & IFormState)` - метод для рендеринга формы на основе переданного состояния. Обновляет состояние вводимых данных и ошибок формы.


#### Класс Contacts
Класс `Contacts` является специализированным формой для ввода контактных данных заказчика. Он наследуется от класса `Form<IOrderForm>` и добавляет дополнительные методы и свойства для управления полями формы.

Конструктор:
- `container: HTMLFormElement` - элемент формы контактных данных.
- `events: IEvents` - объект брокера событий для работы с событиями формы.

В конструкторе вызывается конструктор родительского класса `Form<IOrderForm>`, куда передаются `container` и `events`.

Методы и свойства:

`set phone(value: string)` - сеттер для установки значения в поле телефона формы. Ищет элемент с именем `'phone'` в форме и устанавливает переданное значение.
`set email(value: string)` - сеттер для установки значения в поле `email` формы. Ищет элемент с именем `'email'` в форме и устанавливает переданное значение.

#### Класс Order
Класс `Order` представляет форму для ввода информации о заказе. Он также наследуется от класса `Form<IOrderForm>` и добавляет специфичные методы и свойства для управления полями формы заказа.

Конструктор:
`container: HTMLFormElement` - элемент формы заказа.
`events: IEvents` - объект брокера событий для работы с событиями формы.

Конструктор вызывает конструктор родительского класса `Form<IOrderForm>`, куда передаются `container` и `events`.

Методы и свойства:
- `set address(value: string)` - сеттер для установки значения в поле адреса формы. Ищет элемент с именем 'address' в форме и устанавливает переданное значение.
- `set paymentType(value: string)` - сеттер для сброса состояния кнопок выбора типа оплаты. Удаляет класс `'button_alt-active'` и добавляет класс `'button_alt'` для всех кнопок с именами `'card'` и `'cash'` в форме.

### Слой коммуникации

#### Интерфейс ILarekAPI
Интерфейс `ILarekAPI` определяет методы для работы с `API` интернет-магазина.\
Методы:
- `getCardList(): Promise<ICard[]>` - метод для получения списка товаров. Возвращает промис, который разрешается в массив объектов `ICard`.
- `getCardItem(id: string): Promise<ICard>` - метод для получения информации о конкретном товаре по его идентификатору. Возвращает промис, который разрешается в объект `ICard`.

#### Класс AppApi
Принимает в конструктор экземпляр класса `Api` и предоставляет методы реализующие взаимодействие с бэкендом сервиса, наследуется от базового класса `Api` и реализует интерфейс `ILarekAPI`.\
Конструктор:
- `cdn: string` - `URL` базы для `CDN`, используется для формирования полного пути к изображениям товаров.
- `baseUrl: string` - базовый `URL` сервера `API`, передается в базовый класс `Api`.
- `options?: RequestInit` - опциональные параметры запроса, передаются в базовый класс `Api`.
Методы:
- `getCardList(): Promise<ICard[]>` - отправляет `GET`-запрос на эндпоинт `/product` для получения списка товаров. Возвращает промис, который разрешается в массив объектов `ICard`. Также добавляет базовый `URL` `CDN` к пути изображений.
- `getCardItem(id: string): Promise<ICard>` - отправляет `GET`-запрос на эндпоинт `/product/${id}` для получения информации о конкретном товаре. Возвращает промис, который разрешается в объект `ICard`. Также добавляет базовый `URL` `CDN` к пути изображения.
- `orderProducts(order: IOrder): Promise<{ id: string; total: number }>` - отправляет `POST`-запрос на эндпоинт `/order` для оформления заказа. Передает данные заказа в теле запроса. Возвращает промис, который разрешается в объект, содержащий идентификатор заказа и общую сумму заказа.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*
- `'basket:open'` - генерируется при клике на корзину для открытия корзины.
- `'modal:open'` - генерируется при открытии модального окна.
- `'modal:close'` - генерируется при закрытии модального окна.

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*

Из класса `AppState`:
- `'items:changed'` - генерируется при изменении каталога товаров.
- `'preview:open'` - генерируется при открытии предпросмотра товара.
- `'page:changed'` - генерируется при изменении страницы (например, после добавления или удаления товаров).
- `'formErrorsOrder:change'` - генерируется при изменении ошибок формы заказа.
- `'contacts:ready'` - генерируется при готовности данных контактной формы.
- `'order:ready'` - генерируется при готовности данных формы заказа.

Из класса `Basket`:
- `'order:open'` - генерируется при клике на кнопку оформления заказа в корзине.

Из класса `Contacts`:
- `'formErrorsContacts:change'` - генерируется при изменении ошибок формы контактов.

